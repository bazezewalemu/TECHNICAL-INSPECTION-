<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á‹¨á‰´áŠ­áŠ’áŠ­ áˆáˆ­áˆ˜áˆ« á‰‹á‰µ v54.0 - Full Data Integrity</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ğŸ¨ á‰°áˆˆá‹‹á‹‹áŒ­ á‹¨á‰€áˆˆáˆ á‰…áŠ•á‰¥áˆ­ áŠ¥áŠ“ áˆ†á‰¨áˆ­ (Hover) áˆ›áˆ³áˆ˜áˆªá‹«á‹á‰½ */
        :root { 
            --primary: #004d40; --primary-hover: #00695c;
            --accent: #c62828; --accent-hover: #e53935;
            --blue: #1976d2; --blue-hover: #1565c0;
            --light: #f4f7f6; --dark: #263238; 
            --excel: #1d6f42; --cloud: #6a1b9a;
            --bg-hover: #e8f5e9;
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body { font-family: 'Segoe UI', 'Abyssinica SIL', Arial, sans-serif; background: var(--light); margin: 0; padding: 5px; font-size: 11px; color: var(--dark); line-height: 1.6; }

        /* ğŸ”’ á‹¨áˆ˜áŒá‰¢á‹« áˆµáŠ­áˆªáŠ• á‹²á‹›á‹­áŠ• */
        .auth-container { max-width: 480px; margin: 40px auto; background: white; padding: 40px; border-radius: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); border-top: 10px solid var(--primary); position: relative; }
        .auth-container h2 { text-align: center; color: var(--primary); margin-bottom: 30px; font-size: 24px; font-weight: 800; }
        
        .auth-form input, .auth-form select, .auth-form textarea { 
            width: 100%; margin-bottom: 18px; padding: 15px; box-sizing: border-box; 
            border: 2px solid #eee; border-radius: 12px; font-size: 14px; outline: none; transition: var(--transition);
        }
        .auth-form input:focus { border-color: var(--blue); background: #f0f7ff; box-shadow: 0 0 10px rgba(25,118,210,0.1); }

        .terms-box { 
            height: 120px; overflow-y: auto; background: #f9f9f9; border: 1.5px solid #eee; 
            padding: 15px; font-size: 12px; margin-bottom: 15px; border-radius: 10px; color: #555;
        }

        /* ğŸ“± á‹‹áŠ“á‹ áŠ á•áˆŠáŠ¬áˆ½áŠ• áŒˆáŒ½á‰³ */
        .container { max-width: 100%; display: none; animation: slideUp 0.6s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .header-box { 
            background: linear-gradient(135deg, #ffffff 0%, #f1f8e9 100%);
            padding: 15px 30px; border-radius: 20px; border-bottom: 6px solid var(--primary); 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: var(--shadow); margin-bottom: 15px; 
        }

        /* ğŸ“ á‹¨áˆ˜áˆ¨áŒƒ áˆ›áˆµáŒˆá‰¢á‹« áŠ«áˆ­á‹µ */
        .section-card { 
            background: white; padding: 20px; border-radius: 20px; 
            border: 1px solid #e0e0e0; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        .section-card:hover { box-shadow: 0 10px 30px rgba(0,0,0,0.08); }

        .form-grid { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group label { font-weight: bold; font-size: 11px; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; }

        /* ğŸ”˜ áŠ á‹áˆ«áˆ®á‰½ (Buttons) áŠ¨áˆ†á‰¨áˆ­ áŒ‹áˆ­ */
        .btn { cursor: pointer; border: none; font-weight: bold; color: white; display: inline-flex; align-items: center; justify-content: center; height: 42px; border-radius: 10px; padding: 0 20px; gap: 10px; font-size: 13px; transition: var(--transition); }
        .btn-save { background: var(--primary); } .btn-save:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,77,64,0.3); }
        .btn-blue { background: var(--blue); } .btn-blue:hover { background: var(--blue-hover); transform: translateY(-2px); }
        .btn-red { background: var(--accent); } .btn-red:hover { background: var(--accent-hover); transform: translateY(-2px); }
        .btn-cloud { background: var(--cloud); } .btn-cloud:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(106,27,154,0.3); }
        .btn-excel { background: var(--excel); } .btn-excel:hover { opacity: 0.9; }
        .btn-gray { background: #546e7a; }

        /* ğŸ” á‹¨áˆªá–áˆ­á‰µ áˆ˜áˆáˆˆáŒŠá‹« áŠ­ááˆ */
        .controls-row { 
            display: flex; flex-wrap: wrap; gap: 15px; align-items: center; 
            background: #e1f5fe; padding: 25px; border-radius: 20px; 
            border: 1px solid #81d4fa; margin-bottom: 15px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.02);
        }
        .bulk-box { background: #fffde7; padding: 15px; border-radius: 12px; border: 1.5px solid #fbc02d; display: flex; gap: 10px; align-items: flex-end; }

        /* ğŸ“Š á•áˆ®áŒáˆ½áŠ“áˆ áˆ°áŠ•áŒ áˆ¨á‹¥ (Table) */
        .table-wrapper { 
            overflow-x: auto; background: white; border-radius: 20px; 
            border: 1px solid #eee; box-shadow: 0 15px 40px rgba(0,0,0,0.05); 
        }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        th { background: #f8fbf9; color: var(--primary); font-weight: 900; padding: 18px; text-transform: uppercase; border-bottom: 4px solid #f1f1f1; position: sticky; top: 0; z-index: 10; }
        td { padding: 15px; border-bottom: 1px solid #f5f5f5; text-align: center; font-size: 12px; }
        tr { transition: var(--transition); }
        tr:hover { background-color: var(--bg-hover) !important; transform: scale(1.002); }

        /* ğŸ“ˆ á‹¨áˆµá‰³á‰²áˆµá‰²áŠ­áˆµ áŠ«áˆ­á‹¶á‰½ */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-top: 25px; }
        .stat-card { background: var(--dark); color: white; padding: 30px; border-radius: 22px; text-align: center; position: relative; border-left: 8px solid var(--primary); }
        .stat-card:hover { transform: translateY(-10px); box-shadow: 0 15px 35px rgba(0,0,0,0.25); }
        .stat-card b { font-size: 28px; display: block; margin-top: 10px; color: #fff; }
        
        .admin-only { display: none; }
        .hidden { display: none; }
        
        @media print { .no-print { display: none !important; } .container { display: block !important; } }
    </style>
</head>
<body>

    <div id="authScreen">
        <div id="signInBox" class="auth-container">
            <h2>á‹¨á‰´áŠ­áŠ’áŠ­ áˆáˆ­áˆ˜áˆ« - áˆ˜áŒá‰¢á‹«</h2>
            <div class="auth-form">
                <input type="text" id="loginContact" placeholder="áŠ¢áˆœá‹­áˆ á‹ˆá‹­áˆ áˆµáˆáŠ­ á‰áŒ¥áˆ­">
                <input type="password" id="loginPass" placeholder="á“áˆµá‹ˆáˆ­á‹µ">
                <button onclick="handleSignIn()" class="btn btn-save" style="width:100%; height:55px;">á‰ áŠ áˆµá‰°áˆ›áˆ›áŠ áˆáŠ”á‰³ áŒá‰£</button>
            </div>
            <div style="text-align:center; margin-top:20px;">
                <span class="btn-blue" style="background:none; color:var(--blue); cursor:pointer; text-decoration:underline;" onclick="toggleAuth('signup')">áŠ á‹²áˆµ á‰°áŒ á‰ƒáˆš? áˆ…áŒá‰½áŠ• áŠ áŠ­á‰¥áˆ¨áˆ… á‰°áˆ˜á‹áŒˆá‰¥</span>
            </div>
        </div>

        <div id="signUpBox" class="auth-container" style="display:none;">
            <h2>áŠ á‹²áˆµ á‰°áŒ á‰ƒáˆš áˆá‹áŒˆá‰£</h2>
            <div class="auth-form" id="regStep1">
                <input type="text" id="regName" placeholder="áˆ™áˆ‰ áˆµáˆ">
                <input type="text" id="regContact" placeholder="áŠ¢áˆœá‹­áˆ á‹ˆá‹­áˆ áˆµáˆáŠ­ (09...)">
                <input type="password" id="regPass" placeholder="áŒ áŠ•áŠ«áˆ« á“áˆµá‹ˆáˆ­á‹µ">
                
                <p style="font-weight:bold; margin-bottom:10px;">á‹¨áŠ áŒ á‰ƒá‰€áˆ áˆ…áŒá‰½áŠ“ á‹°áŠ•á‰¦á‰½</p>
                <div class="terms-box">
                    1. á‰ á‹šáˆ… áˆ²áˆµá‰°áˆ áˆ‹á‹­ á‹¨áˆšáˆ˜á‹˜áŒˆá‰¥ áˆ›áŠ•áŠ›á‹áˆ áˆ˜áˆ¨áŒƒ á‰µáŠ­áŠ­áˆˆáŠ› áˆ˜áˆ†áŠ• áŠ áˆˆá‰ á‰µá¢<br>
                    2. á‹¨áˆ˜áŠ•áŒáˆµá‰µ áˆ˜áˆ¨áŒƒ áˆšáˆµáŒ¥áˆ­áŠá‰± á‹¨á‰°áŒ á‰ á‰€ áŠá‹á¤ áˆˆáˆ¶áˆµá‰°áŠ› á‹ˆáŒˆáŠ• áŠ áˆ³áˆá áˆ˜áˆµáŒ á‰µ á‹¨á‰°áŠ¨áˆˆáŠ¨áˆˆ áŠá‹á¢<br>
                    3. á‹¨áˆŒáˆ‹ áˆ°á‹áŠ• áˆ˜áˆˆá‹« (Account) áˆ˜áŒ á‰€áˆ á‰ áŒ¥á‰¥á‰… á‹¨á‰°áŠ¨áˆˆáŠ¨áˆˆ áŠá‹á¢<br>
                    4. áˆ˜áˆ¨áŒƒá‹á‰½áŠ• á‹«áˆˆ áŠ áŒá‰£á‰¥ áˆ›áŒ¥á‹á‰µ á‹ˆá‹­áˆ áˆ›áŒ­á‰ áˆ­á‰ áˆ­ á‰ áˆ…áŒ á‹«áˆµáŒ á‹­á‰ƒáˆá¢<br>
                    5. á‹­áˆ… áˆ²áˆµá‰°áˆ áˆˆá‹áŠ‘ á‰´áŠ­áŠ’áŠ­ áˆáˆ­áˆ˜áˆ« áˆµáˆ« á‰¥á‰» áŠ¥áŠ•á‹²á‹áˆ á‹¨á‰°áˆá‰€á‹° áŠá‹á¢
                </div>
                <label style="font-size:13px; display:flex; align-items:center; gap:8px; cursor:pointer;">
                    <input type="checkbox" id="regTerms" style="width:18px; height:18px;"> áŠ¨áˆ‹á‹­ á‰ á‰°áŒ á‰€áˆ±á‰µ áˆ…áŒá‰½áŠ“ á‹°áŠ•á‰¦á‰½ á‰°áˆµáˆ›áˆá‰»áˆˆáˆ
                </label>
                <button onclick="sendVerification()" class="btn btn-blue" style="width:100%; height:50px; margin-top:20px;">á‹¨áˆ›áˆ¨áŒ‹áŒˆáŒ« áŠ®á‹µ áˆ‹áŠ­áˆáŠ</button>
            </div>

            <div class="auth-form hidden" id="regStep2">
                <p style="text-align:center; color:var(--accent); font-weight:bold;">á‹¨áˆ›áˆ¨áŒ‹áŒˆáŒ« áŠ®á‹µ á‰°áˆáŠ³áˆ!</p>
                <input type="number" id="verifyCodeInput" placeholder="á‰£áˆˆ 6 áŠ áˆƒá‹ áŠ®á‹µ áŠ¥á‹šáˆ… á‹«áˆµáŒˆá‰¡">
                <button onclick="completeRegistration()" class="btn btn-save" style="width:100%; height:50px;">áˆá‹áŒˆá‰£á‹áŠ• áŠ áˆ¨áŒ‹áŒáŒ¥</button>
            </div>
            <div style="text-align:center; margin-top:20px;">
                <span style="color:var(--blue); cursor:pointer;" onclick="toggleAuth('signin')">á‰°áˆ˜áˆˆáˆµ</span>
            </div>
        </div>
    </div>

    <div class="container" id="appContainer">
        <div class="header-box">
            <div class="no-print">ğŸŸ¢ á‰°áŒ á‰ƒáˆšá¡ <b id="displayUser"></b> <span id="syncStatus"></span></div>
            <h2 style="margin:0;">á‹¨á‹ˆáˆá‰ƒá‹­á‰µ áŒ áŒˆá‹´ áˆ°á‰²á‰µ áˆáˆ˜áˆ« á‹áŠ• á‹¨á‰´áŠ­áŠ’áŠ­ áˆáˆ­áˆ˜áˆ« á‰‹á‰µ</h2>
            <button onclick="logout()" class="btn btn-red no-print" style="height:30px; font-size:11px;">á‰ áˆ°áˆ‹áˆ á‹áŒ£</button> 
        </div>

        <div class="section-card no-print">
            <div class="form-grid" id="mainForm">
                <input type="hidden" id="editIndex" value="-1">
                <div class="form-group"><label>á‹°áˆ¨áˆ°áŠ á‰áŒ¥áˆ­</label><input id="receipt" type="text" style="width:90px;"></div>
                <div class="form-group"><label>á‰°áˆ½áŠ¨áˆ­áŠ«áˆª áŠ á‹­áŠá‰µ</label>
                    <select id="vType" style="width:110px;">
                        <option>á‰£áŒƒáŒ…</option><option>áˆá‰°áˆ­</option><option>áŠ áŠáˆµá‰°áŠ›</option><option>áˆ˜áˆˆáˆµá‰°áŠ›</option><option>áŠ¨áá‰°áŠ›</option><option>áŒ­áŠá‰µ</option><option>áˆŒáˆ‹</option>
                    </select>
                </div>
                <div class="form-group"><label>áŠ®á‹µ</label>
                    <select id="code" style="width:130px;"> 
                        <optgroup label="áŠ á‹²áˆµ áŠ á‰ á‰£"><option>áŠ áŠ -1-</option><option>áŠ áŠ -2-</option><option>áŠ áŠ -3-</option><option>áŠ áŠ -4-</option><option>áŠ áŠ -5-</option></optgroup> 
                        <optgroup label="áŠ áˆ›áˆ«"><option>áŠ áˆ›-1-</option><option>áŠ áˆ›-2-</option><option>áŠ áˆ›-3-</option><option>áŠ áˆ›-4-</option><option>áŠ áˆ›-5-</option></optgroup> 
                        <optgroup label="áˆŒáˆá‰½"><option>áŠ¦áˆ®-</option><option>á‹°á‰¡á‰¥-</option><option>áˆ¶áˆ›áˆŒ-</option><option>áŠ á‹áˆ­-</option><option>áŒá‹´áˆ«áˆ</option><option>UN</option></optgroup>
                    </select>
                </div>
                <div class="form-group"><label>áˆ°áˆŒá‹³ á‰áŒ¥áˆ­</label><input id="plate" type="text" style="width:100px;"></div>
                
                <div class="form-group"><label>á‰€áŠ• (áŠ¢á‰µá‹®áŒµá‹«)</label>
                    <div style="display:flex; gap:3px;">
                        <input type="number" id="ethDay" placeholder="á‰€áŠ•" min="1" max="30" style="width:45px;">
                        <select id="ethMonth" style="width:95px;">
                            <option value="1">áˆ˜áˆµáŠ¨áˆ¨áˆ</option><option value="2">áŒ¥á‰…áˆá‰µ</option><option value="3">áˆ…á‹³áˆ­</option>
                            <option value="4">á‰³áˆ…áˆ³áˆµ</option><option value="5">áŒ¥áˆ­</option><option value="6">á‹¨áŠ«á‰²á‰µ</option>
                            <option value="7">áˆ˜áŒ‹á‰¢á‰µ</option><option value="8">áˆšá‹«á‹á‹«</option><option value="9">áŒáŠ•á‰¦á‰µ</option>
                            <option value="10">áˆ°áŠ”</option><option value="11">áˆáˆáˆŒ</option><option value="12">áŠáˆáˆ´</option>
                            <option value="13">áŒ³áŒ‰áˆœáŠ•</option>
                        </select>
                        <input type="number" id="ethYear" value="2018" style="width:65px;">
                    </div>
                </div>

                <div class="form-group"><label>á‰£áˆˆáˆ™á‹«</label><input id="inspector" type="text" style="width:120px;"></div>
                <div class="form-group"><label>áˆáˆ­áˆ˜áˆ« á‰¦á‰³</label>
                    <select id="location" style="width:120px;">
                        <option>á‹áŠ•</option><option>á‹ˆáˆá‰ƒá‹­á‰µ</option><option>áŒ áŒˆá‹´</option><option>áŠ á‹áˆ«</option><option>á‰¤á‰µ áˆáˆ</option><option>á‹³áŠ•áˆ»</option><option>áˆ°á‰²á‰µ</option><option>áˆ›á‹­áŠ«á‹µáˆ«</option><option>á‰†áˆ«áˆªá‰µ</option>
                    </select>
                </div>
                <div class="form-group"><label>á‹¨á‰´áŠ­áŠ’áŠ­ á‹áŒ¤á‰µ</label>
                    <select id="tech" style="width:130px;">
                        <option value="áŠ–áˆ­áˆ›áˆ">áŠ–áˆ­áˆ›áˆ ğŸ™</option><option value="á‰½áŒáˆ­ á‹«áˆˆá‰ á‰µ">á‰½áŒáˆ­ á‹«áˆˆá‰ á‰µ âš ï¸</option>
                    </select>
                </div>
                <div class="form-group"><label>á‹¨áŠ­áá‹« áˆáŠ”á‰³</label>
                    <select id="payStatus" style="width:110px;">
                        <option>á‹¨áŠ¨áˆáˆˆ âœ…</option><option>á‹«áˆáŠ¨áˆáˆˆ âŒ</option><option>áŠáŒ»/Free ğŸ</option>
                    </select>
                </div>
                <div class="form-group"><label>áŒˆá‰¢ (á‰¥áˆ­)</label><input id="amount" type="number" style="width:90px;"></div>
                
                <button onclick="document.getElementById('camFile').click()" class="btn btn-gray" title="áá‰¶ áŠ áŠ•áˆ³">ğŸ“·</button>
                <input type="file" id="camFile" accept="image/*" capture="environment" style="display:none" onchange="handleImage(this)">
                <img id="previewImg" style="width:42px; height:42px; display:none; border-radius:10px; object-fit:cover; border:2px solid var(--primary);">
                
                <button onclick="saveData()" class="btn btn-save" id="saveBtn">áˆ˜áˆ¨áŒƒá‹áŠ• áˆ˜á‹áŒá‰¥</button>
                <button onclick="userSync()" class="btn btn-cloud" id="userSyncBtn">â˜ï¸ á‹ˆá‹° áŠ­áˆ‹á‹á‹µ áˆ‹áŠ­</button>
                <button onclick="fullReset()" class="btn btn-red">áŠ áŒ½á‹³</button>
            </div>
        </div>

        <div class="controls-row no-print">
            <div class="form-group"><label>áŠ¨ á‰€áŠ•/á‹ˆáˆ­</label>
                <div style="display:flex; gap:3px;">
                    <input type="number" id="fStartD" placeholder="á‰€áŠ•" style="width:40px;" oninput="render()">
                    <input type="number" id="fStartM" placeholder="á‹ˆáˆ­" style="width:40px;" oninput="render()">
                </div>
            </div>
            <div class="form-group"><label>áŠ¥áˆµáŠ¨ á‰€áŠ•/á‹ˆáˆ­</label>
                <div style="display:flex; gap:3px;">
                    <input type="number" id="fEndD" placeholder="á‰€áŠ•" style="width:40px;" oninput="render()">
                    <input type="number" id="fEndM" placeholder="á‹ˆáˆ­" style="width:40px;" oninput="render()">
                </div>
            </div>
            <div class="form-group"><label>áˆáŒ£áŠ• ááˆˆáŒ‹ (áˆ°áˆŒá‹³/á‹°áˆ¨áˆ°áŠ/áˆ˜á‹áŒ‹á‰¢)</label>
                <input type="text" id="fSearch" oninput="render()" placeholder="áŠ¥á‹šáˆ… á‹­áƒá‰..." style="width:220px;">
            </div>
            
            <div class="bulk-box admin-only">
                <div class="form-group"><label>áŠ¨ á‰°.á‰</label><input type="number" id="bulkFrom" style="width:55px;"></div>
                <div class="form-group"><label>áŠ¥áˆµáŠ¨ á‰°.á‰</label><input type="number" id="bulkTo" style="width:55px;"></div>
                <button onclick="bulkDelete()" class="btn btn-red" style="height:35px;">áŒ…áˆáˆ‹ áŠ áŒ¥á‹ ğŸ—‘ï¸</button>
            </div>

            <div style="margin-left:auto; display:flex; gap:10px;">
                <button onclick="syncToCloud()" class="btn btn-cloud admin-only" title="á‹¨áŠ á‹µáˆšáŠ• áŠ­áˆ‹á‹á‹µ">â˜ï¸ Admin Sync</button>
                <button onclick="loadFromCloud()" class="btn admin-only" style="background:#4a148c; color:white;" title="áŠ¨á‹°áˆ˜áŠ“ áŠ á‹áˆ­á‹µ">ğŸ“¥ Get</button>
                <button onclick="exportXl()" class="btn btn-excel admin-only" title="á‹ˆá‹° áŠ¤áŠ­áˆ´áˆ á‰€á‹­áˆ­">ğŸ“¤ Excel</button>
                <button onclick="window.print()" class="btn btn-gray admin-only" title="áˆªá–áˆ­á‰µ áŠ á‰µáˆ">ğŸ–¨ Print</button>
                <button onclick="toggleBin()" class="btn btn-red admin-only">â™»ï¸ (<span id="binCount">0</span>)</button>
            </div>
        </div>

        <div id="recycleBin" style="display:none; padding:25px; background:white; border:2px solid var(--accent); border-radius:20px; margin-bottom:20px; box-shadow: var(--shadow);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; color:var(--accent);">áˆªáˆ³á‹­áŠ­áˆ á‰¢áŠ• (á‹¨á‰°áˆ°áˆ¨á‹™ áˆ˜áˆ¨áŒƒá‹á‰½)</h3>
                <button onclick="emptyBin()" class="btn btn-red">áˆáˆ‰áŠ•áˆ áˆˆá‹˜áˆ‹áˆˆáˆ áŠ áŒ¥á‹</button>
            </div>
            <div id="binList" style="max-height:250px; overflow-y:auto; margin-top:20px;"></div>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>á‰°.á‰</th><th>áˆ˜á‹áŒ‹á‰¢</th><th>áá‰¶</th><th>á‹°áˆ¨áˆ°áŠ</th><th>áŠ á‹­áŠá‰µ</th><th>áˆ°áˆŒá‹³</th><th>á‰€áŠ• (á‹“.áˆ)</th><th>á‰£áˆˆáˆ™á‹«</th><th>á‰¦á‰³</th><th>á‹áŒ¤á‰µ</th><th>áŠ­áá‹«</th><th>á‰¥áˆ­</th><th class="no-print">áŠ¥áˆ­áˆáŒƒ</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody"></tbody>
            </table>
        </div>

        <div class="summary-grid">
            <div class="stat-card">áŒ á‰…áˆ‹áˆ‹ á‰°áˆ½áŠ¨áˆ­áŠ«áˆª <b id="stTotal">0</b></div>
            <div class="stat-card" style="background:var(--primary);">áŒ á‰…áˆ‹áˆ‹ áŒˆá‰¢ (á‰¥áˆ­) <b id="stIncome">0.00</b></div>
            <div class="stat-card" style="background:var(--accent);">á‰½áŒáˆ­ á‹«áˆˆá‰£á‰¸á‹ <b id="stIssue">0</b></div>
            <div class="stat-card" style="background:var(--blue);">á‰½áŒáˆ­ á‹¨áˆŒáˆˆá‰£á‰¸á‹ <b id="stNormal">0</b></div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxzdL2xhfYz7bwyVZ7Tx2lJKH23aFPlMKGLUFNlHPjzM99q6USYLcS6KeLJ8wp3c9vCEA/exec";
        const STORAGE_KEY = 'TECH_DB_V54_INTEGRITY';
        const BIN_KEY = 'TECH_BIN_V54_INTEGRITY';
        const USER_DB_KEY = 'TECH_USERS_V54';
        
        let db = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        let bin = JSON.parse(localStorage.getItem(BIN_KEY) || '[]');
        let tempUser = {};
        let generatedOTP = null;
        let currentImg = "";

        // --- ğŸ” Security & Auth Logic ---
        function toggleAuth(m) {
            document.getElementById('signInBox').style.display = m==='signin'?'block':'none';
            document.getElementById('signUpBox').style.display = m==='signup'?'block':'none';
        }

        function sendVerification() {
            const name = document.getElementById('regName').value;
            const contact = document.getElementById('regContact').value;
            const terms = document.getElementById('regTerms').checked;
            if(!name || !contact || !terms) return alert("áŠ¥á‰£áŠ­áˆ… áˆµáˆá£ áˆ˜áŒˆáŠ› á‹«áˆµáŒˆá‰£áŠ“ á‰ áˆ…áŒ‰ á‰°áˆµáˆ›áˆ›!");
            generatedOTP = Math.floor(100000 + Math.random() * 900000);
            alert("á‹¨áˆ›áˆ¨áŒ‹áŒˆáŒ« áŠ®á‹µáˆ…á¦ " + generatedOTP);
            tempUser = { name, contact, pass: document.getElementById('regPass').value };
            document.getElementById('regStep1').classList.add('hidden');
            document.getElementById('regStep2').classList.remove('hidden');
        }

        function completeRegistration() {
            const code = document.getElementById('verifyCodeInput').value;
            if(code == generatedOTP) {
                let users = JSON.parse(localStorage.getItem(USER_DB_KEY) || '[]');
                users.push(tempUser);
                localStorage.setItem(USER_DB_KEY, JSON.stringify(users));
                alert("áˆá‹áŒˆá‰£á‹ á‰°áˆ³áŠ­á‰·áˆ!");
                location.reload();
            } else alert("á‹¨á‰°áˆ³áˆ³á‰° áŠ®á‹µ áŠá‹!");
        }

        function handleSignIn() {
            const c = document.getElementById('loginContact').value;
            const p = document.getElementById('loginPass').value;
            if(c === "admin@tech.com" && p === "1313") loginSuccess("Admin", "admin");
            else {
                let users = JSON.parse(localStorage.getItem(USER_DB_KEY) || '[]');
                const found = users.find(u => u.contact === c && u.pass === p);
                if(found) loginSuccess(found.name, "user"); else alert("áˆ˜áˆ¨áŒƒá‹ áˆµáˆ…á‰°á‰µ áŠá‹!");
            }
        }

        function loginSuccess(n, r) {
            sessionStorage.setItem('isLogged', 'true');
            sessionStorage.setItem('role', r);
            sessionStorage.setItem('activeUser', n);
            initApp();
        }

        function logout() { sessionStorage.clear(); location.reload(); }

        // --- âš™ï¸ Core Application Logic ---
        function initApp() {
            if(sessionStorage.getItem('isLogged')) {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('displayUser').innerText = sessionStorage.getItem('activeUser');
                if(sessionStorage.getItem('role') === 'admin') {
                    document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'inline-flex');
                }
                render();
            }
        }

        function handleImage(input) {
            const r = new FileReader();
            r.onload = e => { currentImg = e.target.result; document.getElementById('previewImg').src = currentImg; document.getElementById('previewImg').style.display = 'block'; };
            r.readAsDataURL(input.files[0]);
        }

        function saveData() {
            const plate = document.getElementById('plate').value;
            if(!plate) return alert("áˆ°áˆŒá‹³ á‰áŒ¥áˆ­ á‹«áˆµáŒˆá‰¡!");
            const data = {
                id: Date.now(),
                registeredBy: sessionStorage.getItem('activeUser'),
                receipt: document.getElementById('receipt').value,
                vType: document.getElementById('vType').value,
                code: document.getElementById('code').value,
                plate: plate,
                day: parseInt(document.getElementById('ethDay').value) || 1,
                month: parseInt(document.getElementById('ethMonth').value) || 1,
                year: parseInt(document.getElementById('ethYear').value) || 2018,
                inspector: document.getElementById('inspector').value,
                location: document.getElementById('location').value,
                tech: document.getElementById('tech').value,
                payStatus: document.getElementById('payStatus').value,
                amount: Number(document.getElementById('amount').value) || 0,
                photo: currentImg
            };
            const idx = parseInt(document.getElementById('editIndex').value);
            if(idx > -1) db[idx] = data; else db.unshift(data);
            save(); fullReset(); render();
        }

        function render() {
            const body = document.getElementById('dataTableBody'), search = document.getElementById('fSearch').value.toLowerCase();
            const fsD = parseInt(document.getElementById('fStartD').value) || 0;
            const fsM = parseInt(document.getElementById('fStartM').value) || 0;
            const feD = parseInt(document.getElementById('fEndD').value) || 31;
            const feM = parseInt(document.getElementById('fEndM').value) || 13;
            body.innerHTML = ''; let t = 0, inc = 0, issue = 0, norm = 0;
            db.forEach((d, i) => {
                const matchSearch = (d.plate + d.receipt + (d.registeredBy || "")).toLowerCase().includes(search);
                let matchDate = true;
                if(fsM > 0 || feM < 13) {
                    const currentVal = (d.month * 100) + d.day;
                    matchDate = currentVal >= (fsM * 100 + fsD) && currentVal <= (feM * 100 + feD);
                }
                if(matchSearch && matchDate) {
                    t++; inc += d.amount; if(d.tech === "á‰½áŒáˆ­ á‹«áˆˆá‰ á‰µ") issue++; else norm++;
                    body.innerHTML += `<tr>
                        <td>${t}</td><td>${d.registeredBy}</td>
                        <td>${d.photo ? `<img src="${d.photo}" width="35" style="border-radius:6px;">` : '-'}</td>
                        <td>${d.receipt}</td><td>${d.vType}</td><td><b>${d.code}${d.plate}</b></td>
                        <td>${d.day}/${d.month}/${d.year}</td><td>${d.inspector}</td><td>${d.location}</td>
                        <td style="font-weight:bold; color:${d.tech==='áŠ–áˆ­áˆ›áˆ'?'green':'red'}">${d.tech}</td>
                        <td>${d.payStatus}</td><td>${d.amount.toFixed(2)}</td>
                        <td class="no-print">
                            <button onclick="editItem(${i})" style="color:blue; border:none; background:none; cursor:pointer;">âœï¸</button>
                            <button onclick="moveToBin(${i})" style="color:red; border:none; background:none; cursor:pointer;">ğŸ—‘ï¸</button>
                        </td></tr>`;
                }
            });
            document.getElementById('stTotal').innerText = t;
            document.getElementById('stIncome').innerText = inc.toFixed(2);
            document.getElementById('stIssue').innerText = issue;
            document.getElementById('stNormal').innerText = norm;
            document.getElementById('binCount').innerText = bin.length;
        }

        function bulkDelete() {
            const f = parseInt(document.getElementById('bulkFrom').value) - 1;
            const t = parseInt(document.getElementById('bulkTo').value);
            if(f < 0 || t > db.length) return alert("á‰°.á‰ á‹«áˆµá‰°áŠ«áŠ­áˆ‰!");
            if(confirm("á‹­áŒ¥á‹?")) { bin = db.splice(f, t-f).concat(bin); save(); render(); }
        }

        function fullReset() {
            document.getElementById('editIndex').value = "-1";
            document.getElementById('saveBtn').innerText = "áˆ˜áˆ¨áŒƒá‹áŠ• áˆ˜á‹áŒá‰¥";
            document.querySelectorAll('#mainForm input').forEach(i => { if(i.id !== 'ethYear') i.value = ''; });
            currentImg = ""; document.getElementById('previewImg').style.display='none';
        }

        function editItem(i) {
            const d = db[i]; document.getElementById('plate').value = d.plate; document.getElementById('receipt').value = d.receipt;
            document.getElementById('amount').value = d.amount; document.getElementById('ethDay').value = d.day;
            document.getElementById('ethMonth').value = d.month; document.getElementById('editIndex').value = i;
            document.getElementById('saveBtn').innerText = "áˆ˜áˆ¨áŒƒá‹áŠ• áŠ á‹µáˆµ"; window.scrollTo(0,0);
        }

        function moveToBin(i) { if(confirm("áˆªáˆ³á‹­áŠ­áˆ á‰¢áŠ•?")) { bin.unshift(db[i]); db.splice(i,1); save(); render(); } }
        function toggleBin() { const d = document.getElementById('recycleBin'); d.style.display = d.style.display==='none'?'block':'none'; updateBinList(); }
        function updateBinList() {
            document.getElementById('binList').innerHTML = bin.map((x, i) => `
                <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                    <span>${x.plate} (${x.day}/${x.month})</span>
                    <div><button onclick="restore(${i})">ğŸ”„</button><button onclick="delForever(${i})">âŒ</button></div>
                </div>`).join('');
        }
        function restore(i) { db.push(bin[i]); bin.splice(i,1); save(); render(); updateBinList(); }
        function delForever(i) { if(confirm("áˆˆá‹˜áˆ‹áˆˆáˆ?")) { bin.splice(i,1); save(); render(); updateBinList(); } }
        function emptyBin() { bin = []; save(); render(); updateBinList(); }

        // --- â˜ï¸ User Cloud Sync Feature ---
        function userSync() {
            const activeUser = sessionStorage.getItem('activeUser');
            // á‰°áŒ á‰ƒáˆšá‹ á‹¨áˆ˜á‹˜áŒˆá‰£á‰¸á‹áŠ• áˆ˜áˆ¨áŒƒá‹á‰½ á‰¥á‰» áˆˆá‹­á‰¶ áˆ˜áˆ‹áŠ­ (áˆˆá‹°áˆ…áŠ•áŠá‰µ áˆ²á‰£áˆ)
            const userRecords = db.filter(record => record.registeredBy === activeUser);
            if(userRecords.length === 0) return alert("áŠ¥áˆµáŠ«áˆáŠ• á‹¨áˆ‹áŠ­áŠ¸á‹ áˆ˜áˆ¨áŒƒ á‹¨áˆˆáˆ!");
            
            const btn = document.getElementById('userSyncBtn');
            btn.innerText = "â³ á‰ áˆ˜áˆ‹áŠ­ áˆ‹á‹­...";
            
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(userRecords) })
            .then(() => {
                alert("á‹¨áˆ˜á‹˜áŒˆá‰¥áŠ«á‰¸á‹ " + userRecords.length + " áˆ˜áˆ¨áŒƒá‹á‰½ á‰ áŠ­áˆ‹á‹á‹µ áˆ‹á‹­ á‰°á‰€áˆáŒ á‹‹áˆá¢");
                btn.innerText = "â˜ï¸ á‹ˆá‹° áŠ­áˆ‹á‹á‹µ á‰°áˆáŠ³áˆ âœ…";
                setTimeout(() => btn.innerText = "â˜ï¸ á‹ˆá‹° áŠ­áˆ‹á‹á‹µ áˆ‹áŠ­", 3000);
            }).catch(e => alert("áˆµáˆ…á‰°á‰µ á‰°áŠ¨áˆµá‰·áˆ!"));
        }

        function syncToCloud() {
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(db) })
            .then(() => alert("áŠ á‹µáˆšáŠ• áˆ²áŠ•áŠ­ á‰°áˆ³áŠ­á‰·áˆ!"));
        }
        function loadFromCloud() {
            fetch(SCRIPT_URL).then(r => r.json()).then(data => { db = data; save(); render(); alert("á‹³á‰³ á‹ˆáˆ­á‹·áˆ!"); });
        }
        function exportXl() { 
            const ws = XLSX.utils.json_to_sheet(db); 
            const wb = XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(wb, ws, "Tech_Report"); 
            XLSX.writeFile(wb, "Tech_Audit_Report.xlsx"); 
        }
        function save() { 
            localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); 
            localStorage.setItem(BIN_KEY, JSON.stringify(bin)); 
        }
        window.onload = initApp;
    </script>
</body>
</html>
