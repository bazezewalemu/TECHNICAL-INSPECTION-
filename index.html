<!DOCTYPE html>
<html lang="am">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á‹¨á‰´áŠ­áŠ’áŠ­ áˆáˆ­áˆ˜áˆ« á‰‹á‰µ v37.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
         :root {
            --primary: #004d40;
            --accent: #c62828;
            --blue: #1976d2;
            --light: #f4f7f6;
            --dark: #263238;
            --excel: #1d6f42;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--light);
            margin: 0;
            padding: 5px;
            font-size: 11px;
        }
        
        .container {
            max-width: 100%;
            display: none;
        }
        
        .header-box {
            background: white;
            padding: 8px 15px;
            border-radius: 8px;
            border-top: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 5px;
        }
        
        .section-card {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 5px;
        }
        
        .form-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: flex-end;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }
        
        .form-group label {
            font-weight: bold;
            font-size: 9px;
            color: var(--primary);
        }
        
        input,
        select,
        button {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            outline: none;
            font-size: 11px;
        }
        
        .btn {
            cursor: pointer;
            border: none;
            font-weight: bold;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 30px;
            border-radius: 4px;
            padding: 0 8px;
            gap: 4px;
        }
        
        .btn-save {
            background: var(--primary);
        }
        
        .btn-blue {
            background: var(--blue);
        }
        
        .btn-red {
            background: var(--accent);
        }
        
        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
            background: #e1f5fe;
            padding: 6px;
            border-radius: 8px;
            border: 1px solid #b3e5fc;
            margin-bottom: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-top: 5px;
            font-size: 10px;
        }
        
        th,
        td {
            padding: 4px;
            border: 1px solid #eee;
            text-align: center;
        }
        
        th {
            background: #f5f5f5;
            color: var(--primary);
        }
        
        .summary-box {
            background: var(--dark);
            color: white;
            padding: 10px;
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            text-align: center;
            margin-top: 5px;
        }
        
        .bulk-box {
            background: #fff3e0;
            border: 1px solid #ffb74d;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 5px;
            display: none;
            align-items: center;
            gap: 8px;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            .container {
                display: block !important;
            }
        }
    </style>
</head>

<body>
    <div id="loginScreen">
        <div style="background:white; padding:30px; border-radius:12px; width:260px; margin: 80px auto; text-align:center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <h2 style="color:var(--primary)">á‹¨á‰´áŠ­áŠ’áŠ­ áˆáˆ­áˆ˜áˆ« v37.1</h2> <input type="text" id="uName" placeholder="á‰°áŒ á‰ƒáˆš áˆµáˆ" style="width:100%; margin-bottom:10px;"> <input type="password" id="uPass" placeholder="á“áˆµá‹ˆáˆ­á‹µ" style="width:100%; margin-bottom:20px;"> <button onclick="login()" class="btn btn-save"
                style="width:100%">áŒá‰£</button> </div>
    </div>
    <div class="container" id="appContainer">
        <div class="header-box">
            <div class="no-print">ğŸ‘¤ <b id="displayUser" style="color:var(--blue)"></b> <span id="syncIndicator" style="font-size:9px; color:gray; margin-left:5px;">â— Offline</span> </div>
            <h3 style="margin:0; text-align: center; flex-grow:1;">á‹¨á‹ˆáˆá‰ƒá‹­á‰µ áŒ áŒˆá‹´ áˆ°á‰²á‰µ áˆáˆ˜áˆ« á‹áŠ• á‹¨á‰´áŠ­áŠ’áŠ­ áˆáˆ­áˆ˜áˆ« á‰‹á‰µ</h3> <button onclick="logout()" class="btn btn-red no-print" style="height:22px; font-size:9px;">á‹áŒ£</button> </div>
        <div class="section-card no-print">
            <div class="form-grid"> <input type="hidden" id="editIndex" value="-1">
                <div class="form-group"><label>á‹°áˆ¨áˆ°áŠ</label><input id="receipt" type="text" style="width:60px;"></div>
                <div class="form-group"><label>áŠ á‹­áŠá‰µ</label><select id="vType" style="width:85px;"><option>á‰£áŒƒáŒ…</option><option>áˆá‰°áˆ­</option><option>áŠ áŠáˆµá‰°áŠ›</option><option>áˆ˜áˆˆáˆµá‰°áŠ›</option><option>áŠ¨áá‰°áŠ›</option><option>áŒ­áŠá‰µ</option></select></div>
                <div class="form-group"><label>áŠ®á‹µ</label><select id="code" style="width:110px;"> <optgroup label="áŠ á‹²áˆµ áŠ á‰ á‰£"><option>áŠ áŠ -1-</option><option>áŠ áŠ -2-</option><option>áŠ áŠ -3-</option><option>áŠ áŠ -4-</option><option>áŠ áŠ -5-</option></optgroup> <optgroup label="áŠ áˆ›áˆ«"><option>áŠ áˆ›-1-</option><option>áŠ áˆ›-2-</option><option>áŠ áˆ›-3-</option><option>áŠ áˆ›-4-</option><option>áŠ áˆ›-5-</option></optgroup> <optgroup label="áŠ¦áˆ®áˆšá‹«"><option>áŠ¦áˆ®-1-</option><option>áŠ¦áˆ®-2-</option><option>áŠ¦áˆ®-3-</option><option>áŠ¦áˆ®-4-</option><option>áŠ¦áˆ®-5-</option></optgroup> <optgroup label="áˆŒáˆá‰½"><option>á‹°á‰¡á‰¥-</option><option>áˆ¶áˆ›áˆŒ-</option><option>áŠ á‹áˆ­-</option><option>á‰¤áŒ‰-</option><option>áŒ‹áˆ-</option><option>áˆáˆ¨-</option><option>á‹µáˆ¬-</option><option>áŒá‹´áˆ«áˆ</option><option>áˆá‹©</option><option>UN</option> </select>                    </div>
                <div class="form-group"><label>áˆ°áˆŒá‹³</label><input id="plate" type="text" style="width:70px;"></div>
                <div class="form-group"><label>á‰€áŠ•</label>
                    <div style="display:flex; gap:1px;"><select id="eDay" style="width:38px;"></select><select id="eMonth" style="width:75px;"><option value="01">áˆ˜áˆµáŠ¨áˆ¨áˆ</option><option value="02">áŒ¥á‰…áˆá‰µ</option><option value="03">áˆ…á‹³áˆ­</option><option value="04">á‰³áˆ…áˆ³áˆµ</option><option value="05">áŒ¥áˆ­</option><option value="06">á‹¨áŠ«á‰²á‰µ</option><option value="07">áˆ˜áŒ‹á‰¢á‰µ</option><option value="08">áˆšá‹«á‹á‹«</option><option value="09">áŒáŠ•á‰¦á‰µ</option><option value="10">áˆ°áŠ”</option><option value="11">áˆáˆáˆŒ</option><option value="12">áŠáˆáˆ´</option><option value="13">áŒ³áŒ‰áˆœáŠ•</option></select>
                        <select id="eYear" style="width:55px;"></select>
                    </div>
                </div>
                <div class="form-group"><label>á‰£áˆˆáˆ™á‹«</label><input id="inspector" type="text" style="width:95px;"></div>
                <div class="form-group"><label>á‰¦á‰³</label><select id="location" style="width:110px;"> <option>á‹áŠ•</option><option>á‹ˆáˆá‰ƒá‹­á‰µ</option><option>áŒ áŒˆá‹´</option><option>áŠ á‹áˆ«</option><option>á‰¤á‰µ áˆáˆ</option><option>á‰ƒáá‰µá‹«</option><option>á‹³áŠ•áˆ»</option><option>áˆ°á‰²á‰µ</option><option>áˆ›á‹­áŠ«á‹µáˆ«</option><option>á‰†áˆ«áˆªá‰µ</option> </select>                    </div>
                <div class="form-group"><label>á‹áŒ¤á‰µ</label><select id="tech" style="width:100px;"><option value="áŠ–áˆ­áˆ›áˆ">áŠ–áˆ­áˆ›áˆ ğŸ™</option><option value="á‰½áŒáˆ­ á‹«áˆˆá‰ á‰µ">âš ï¸ á‰½áŒáˆ­ á‹«áˆˆá‰ á‰µ</option></select></div>
                <div class="form-group"><label>áŠ­áá‹«</label><select id="payStatus" style="width:85px;"><option value="á‹¨áŠ¨áˆáˆˆ">á‹¨áŠ¨áˆáˆˆ âœ…</option><option value="á‹«áˆáŠ¨áˆáˆˆ">á‹«áˆáŠ¨áˆáˆˆ âŒ</option></select></div>
                <div class="form-group"><label>á‰¥áˆ­</label><input id="amount" type="number" style="width:60px;"></div> <img id="previewImg" style="width:30px; height:30px; display:none; border-radius:4px; border:1px solid #ccc;"> </div>
        </div>
               <button onclick="loadFromCloud()" class="btn btn-blue" id="loadBtn" style="background:#6a1b9a;">ğŸ“¥ áˆáˆ‰áŠ•áˆ áŠ áˆáŒ£</button>
        <div class="controls-row no-print"> <button onclick="document.getElementById('camFile').click()" class="btn" style="background:#546e7a;">ğŸ“·</button><input type="file" id="camFile" accept="image/*" capture="environment" style="display:none" onchange="handleImage(this)"> <button id="saveBtn"
                onclick="saveData()" class="btn btn-save">áˆ˜á‹áŒá‰¥</button> <button id="cancelBtn" onclick="resetForm()" class="btn btn-red" style="display:none;">á‰°á‹</button>
            <div style="width:1px; height:20px; background:#b3e5fc; margin:0 5px;"></div> <input type="date" id="reportFrom" onchange="render()" style="width:105px;"> <input type="date" id="reportTo" onchange="render()" style="width:105px;"> <input type="text" id="fSearch" placeholder="áˆ°áˆŒá‹³/á‹°áˆ¨áˆ°áŠ..." oninput="render()" style="width:100px;">            <button onclick="syncToCloud()" class="btn btn-blue" id="syncBtn">â˜ï¸ Cloud</button> <button onclick="exportXl()" class="btn" style="background:var(--excel); color:white;">ğŸ“¤ Excel</button> <button onclick="document.getElementById('importFile').click()"
                class="btn" style="background:#2e7d32;">ğŸ“¥ Import</button><input type="file" id="importFile" accept=".xlsx,.xls" onchange="autoProcessFile(this)" style="display:none"> <button onclick="recoverBackup()" class="btn" style="background:#607d8b;">ğŸ”„ Backup</button>            <button onclick="window.print()" class="btn" style="background:#455a64;">ğŸ–¨ áˆªá–áˆ­á‰µ</button> <button onclick="toggleBulkDelete()" class="btn" style="background:#ef6c00;">ğŸ“… á‰ áŒ…áˆáˆ‹</button> <button onclick="toggleBin()" class="btn btn-red">â™»ï¸ (<span id="binCount">0</span>)</button>
            <div id="importStatus" style="font-size:9px;"></div>
        </div>
        <div id="bulkDeleteBox" class="bulk-box no-print"> <b>áŠ¨á‰°áˆ« á‰áŒ¥áˆ­á¡</b> <input type="number" id="bulkFrom" style="width:50px;"> <b>áŠ¥áˆµáŠ¨á¡</b> <input type="number" id="bulkTo" style="width:50px;"> <button onclick="bulkDelete()" class="btn btn-red" style="height:25px;">âŒ áŠ áŒ¥á‹</button> </div>
        <div id="recycleBin" style="display:none; padding:8px; background:#fff3f3; border:1px solid red; border-radius:8px; margin-bottom:5px;">
            <div style="display:flex; justify-content:space-between;"><b>á‰¢áŠ•</b><button onclick="emptyBin()" class="btn btn-red" style="height:18px; font-size:9px;">áˆáˆ‰áŠ•áˆ áŠ áŒ¥á‹</button></div>
            <div id="binList" style="max-height:120px; overflow-y:auto;"></div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>á‰°.á‰</th>
                    <th>áá‰¶</th>
                    <th>á‹°áˆ¨áˆ°áŠ</th>
                    <th>áŠ á‹­áŠá‰µ</th>
                    <th>áˆ°áˆŒá‹³</th>
                    <th>á‰€áŠ•</th>
                    <th>á‰£áˆˆáˆ™á‹«</th>
                    <th>á‰¦á‰³</th>
                    <th>á‹áŒ¤á‰µ</th>
                    <th>áŠ­áá‹«</th>
                    <th>á‰¥áˆ­</th>
                    <th class="no-print">áŠ¥áˆ­áˆáŒƒ</th>
                </tr>
            </thead>
            <tbody id="dataTableBody"></tbody>
        </table>
        <div class="summary-box">
            <div class="stat-item">áŒ á‰…áˆ‹áˆ‹ á‰°áˆ½áŠ¨áˆ­áŠ«áˆª: <b id="stTotal" style="color:#4fc3f7;">0</b></div>
            <div class="stat-item">áŒ á‰…áˆ‹áˆ‹ áŒˆá‰¢: <b id="stIncome" style="color:#4fc3f7;">0</b> á‰¥áˆ­</div>
            <div class="stat-item">áŠ–áˆ­áˆ›áˆ ğŸ™: <b id="stNormal" style="color:#66bb6a;">0</b></div>
            <div class="stat-item">á‰½áŒáˆ­ á‹«áˆˆá‰£á‰¸á‹ âš ï¸: <b id="stIssue" style="color:#ef5350;">0</b></div>
        </div>
    </div>
    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxzdL2xhfYz7bwyVZ7Tx2lJKH23aFPlMKGLUFNlHPjzM99q6USYLcS6KeLJ8wp3c9vCEA/exec";
        let db = JSON.parse(localStorage.getItem('W_V36_DB') || '[]');
        let bin = JSON.parse(localStorage.getItem('W_V36_BIN') || '[]');
        let currentImg = "";
// áŠ¢áŠ•á‰°áˆ­áŠ”á‰µ áˆ˜áŠ–áˆ­ áŠ áˆˆáˆ˜áŠ–áˆ©áŠ• á‹¨áˆšáŠ¨á‰³á‰°áˆ á‰°áŒá‰£áˆ­
function updateOnlineStatus() {
    const indicator = document.getElementById('syncIndicator');
    if (navigator.onLine) {
        indicator.innerHTML = "â— Online";
        indicator.style.color = "#4caf50"; // áŠ áˆ¨áŠ•áŒ“á‹´
    } else {
        indicator.innerHTML = "â— Offline";
        indicator.style.color = "gray"; // áŒáˆ«áŒ«
    }
}

// áŠ¢áŠ•á‰°áˆ­áŠ”á‰µ áˆ²áˆ˜áŒ£áŠ“ áˆ²áˆ„á‹µ á‰ áˆ«áˆ± áŠ¥áŠ•á‹²á‰€á‹­áˆ­
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// áŒˆáŒ¹ áˆ²áŠ¨áˆá‰µ áˆ˜áŒ€áˆ˜áˆªá‹« á‹«áˆˆá‹áŠ• áˆáŠ”á‰³ áˆˆáˆ›á‹ˆá‰…
window.addEventListener('load', updateOnlineStatus);
       async function loadFromCloud() {
    const pass = prompt("á‹¨áŠ á‹µáˆšáŠ• áˆšáˆµáŒ¥áˆ­ á‰áˆá á‹«áˆµáŒˆá‰¡á¡");
    if (pass !== "1313") return alert("áŠ áˆá‰°áˆá‰€á‹°áˆá‹á‰µáˆ!"); // áˆšáˆµáŒ¥áˆ­ á‰áˆááˆ…

    const btn = document.getElementById('loadBtn');
    btn.innerText = "â³ á‰ áˆ›áˆáŒ£á‰µ áˆ‹á‹­...";
    
    try {
        const response = await fetch(SCRIPT_URL);
        const cloudData = await response.json();
        
        if (cloudData.length > 0) {
            db = cloudData; // á‹¨áŠ áˆáŠ‘áŠ• á‹³á‰³ á‰  Cloud á‹³á‰³ áˆ˜á‰°áŠ«á‰µ
            save(); // á‹ˆá‹° Local Storage áˆ´á‰­ áˆ›á‹µáˆ¨áŒ
            render(); // áˆ°áŠ•áŒ áˆ¨á‹¡áŠ• áˆ›á‹°áˆµ
            alert("áˆáˆ‰áˆ áˆ˜áˆ¨áŒƒá‹á‰½ áŠ¨ Cloud á‹ˆáˆ­á‹°á‹‹áˆ!");
        } else {
            alert("á‰  Cloud áˆ‹á‹­ áˆáŠ•áˆ áˆ˜áˆ¨áŒƒ á‹¨áˆˆáˆ!");
        }
    } catch (e) {
        alert("áˆ˜áˆ¨áŒƒá‹áŠ• áˆ›áˆáŒ£á‰µ áŠ áˆá‰°á‰»áˆˆáˆá¦ " + e);
    } finally {
        btn.innerText = "ğŸ“¥ áˆáˆ‰áŠ•áˆ áŠ áˆáŒ£";
    }
}
        function login() {
            if (document.getElementById('uPass').value === "1313") {
                sessionStorage.setItem('isLogged', 'true');
                sessionStorage.setItem('activeUser', document.getElementById('uName').value || "Admin");
                initApp();
            } else {
                alert("á‰°áˆ³áˆµá‰·áˆ!");
            }
        }

        function initApp() {
            if (sessionStorage.getItem('isLogged')) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('displayUser').innerText = sessionStorage.getItem('activeUser');
                setupForm();
                render();
            }
        }
        window.onload = initApp;

        function setupForm() {
            const d = document.getElementById('eDay'),
                y = document.getElementById('eYear');
            d.innerHTML = "";
            y.innerHTML = "";
            for (let i = 1; i <= 30; i++) d.innerHTML += `<option>${i.toString().padStart(2,'0')}</option>`;
            for (let i = 2015; i <= 2030; i++) y.innerHTML += `<option ${i===2017?'selected':''}>${i}</option>`;
        }

        function handleImage(input) {
            if (input.files && input.files[0]) {
                const r = new FileReader();
                r.onload = e => {
                    currentImg = e.target.result;
                    document.getElementById('previewImg').src = currentImg;
                    document.getElementById('previewImg').style.display = 'block';
                };
                r.readAsDataURL(input.files[0]);
            }
        }

        function saveData() {
            const p = document.getElementById('plate').value;
            if (!p) return alert("áˆ°áˆŒá‹³?");
            const d = document.getElementById('eDay').value,
                m = document.getElementById('eMonth').value,
                y = document.getElementById('eYear').value;
            const data = {
                receipt: document.getElementById('receipt').value,
                vType: document.getElementById('vType').value,
                code: document.getElementById('code').value,
                plate: p,
                inspector: document.getElementById('inspector').value,
                date: `${d}/${m}/${y}`,
                filterDate: `${y}-${m}-${d}`,
                location: document.getElementById('location').value,
                tech: document.getElementById('tech').value,
                payStatus: document.getElementById('payStatus').value,
                amount: Number(document.getElementById('amount').value) || 0,
                photo: currentImg,
                isoDate: new Date().toISOString()
            };
            const idx = parseInt(document.getElementById('editIndex').value);
            if (idx > -1) db[idx] = data;
            else db.unshift(data);
            save();
            render();
            resetForm();
            if (navigator.onLine && SCRIPT_URL.length > 20) syncToCloud();
        }
 function render() {
    const b = document.getElementById('dataTableBody'),
        s = document.getElementById('fSearch').value.toLowerCase(),
        f = document.getElementById('reportFrom').value,
        t = document.getElementById('reportTo').value;
    b.innerHTML = '';
    let st = { inc: 0, tot: 0, n: 0, iss: 0 };

    db.forEach((d, i) => {
        const dt = d.filterDate || "";
        
        // áˆµáˆ…á‰°á‰±áŠ• áŠáŠ­áˆµ á‹¨á‰°á‹°áˆ¨áŒˆá‰ á‰µ á‰¦á‰³á¡
        const plateStr = String(d.plate || "");
        const receiptStr = String(d.receipt || "");
        const mS = (plateStr + receiptStr).toLowerCase().includes(s);
        
        const mD = (!f || dt >= f) && (!t || dt <= t);

        if (mS && mD) {
            st.tot++;
            st.inc += Number(d.amount) || 0;
            d.tech === 'áŠ–áˆ­áˆ›áˆ' ? st.n++ : st.iss++;
            
            b.innerHTML += `<tr>
                <td>${st.tot}</td>
                <td>${d.photo ? `<img src="${d.photo}" style="width:18px;">` : '-'}</td>
                <td>${d.receipt}</td>
                <td>${d.vType}</td>
                <td><b>${d.code || ""}${d.plate}</b></td>
                <td>${d.date}</td>
                <td>${d.inspector}</td>
                <td>${d.location}</td>
                <td style="color:${d.tech === 'áŠ–áˆ­áˆ›áˆ' ? 'blue' : 'red'}">${d.tech}</td>
                <td>${d.payStatus}</td>
                <td>${d.amount}</td>
                <td class="no-print">
                    <button onclick="editItem(${i})">âœï¸</button>
                    <button onclick="moveToBin(${i})">ğŸ—‘ï¸</button>
                </td>
            </tr>`;
        }
    });

    document.getElementById('stTotal').innerText = st.tot;
    document.getElementById('stIncome').innerText = st.inc;
    document.getElementById('stNormal').innerText = st.n;
    document.getElementById('stIssue').innerText = st.iss;
    document.getElementById('binCount').innerText = bin.length;
}


        function save() {
    localStorage.setItem('W_V36_DB', JSON.stringify(db));
    localStorage.setItem('W_V36_BIN', JSON.stringify(bin));
    localStorage.setItem('W_V36_BACKUP', JSON.stringify(db));
}
    </script>
</body>


</html>





